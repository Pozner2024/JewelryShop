(function(){const l=document.createElement("link").relList;if(l&&l.supports&&l.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))r(e);new MutationObserver(e=>{for(const n of e)if(n.type==="childList")for(const t of n.addedNodes)t.tagName==="LINK"&&t.rel==="modulepreload"&&r(t)}).observe(document,{childList:!0,subtree:!0});function i(e){const n={};return e.integrity&&(n.integrity=e.integrity),e.referrerPolicy&&(n.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?n.credentials="include":e.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function r(e){if(e.ep)return;e.ep=!0;const n=i(e);fetch(e.href,n)}})();document.addEventListener("DOMContentLoaded",()=>{const d=new URLSearchParams(window.location.search),l=document.getElementById("profileBtn"),i=document.getElementById("loginModal"),r=document.getElementById("registerModal");document.getElementById("userMenu");const e=document.getElementById("closeLoginModal"),n=document.getElementById("closeRegisterModal"),t=document.getElementById("showRegisterModal"),s=document.getElementById("showLoginModal"),u=document.getElementById("loginForm"),a=document.getElementById("registerForm"),p=document.getElementById("logoutBtn");L();const h=document.getElementById("profileDropdownBtn"),v=document.getElementById("profileDropdown");if(h&&h.addEventListener("click",o=>{o.stopPropagation(),v.classList.toggle("show")}),window.addEventListener("click",o=>{v&&!v.contains(o.target)&&!h.contains(o.target)&&v.classList.remove("show")}),d.has("activated")){const o=document.getElementById("loginStatusMessage");o&&(o.textContent="Аккаунт успешно активирован. Пожалуйста, войдите.",o.className="status-message success"),E(i);const c=window.location.protocol+"//"+window.location.host+window.location.pathname;window.history.pushState({path:c},"",c)}if(d.has("login")){const o=document.querySelector('#loginForm input[name="loginOrEmail"]');o&&(o.value=d.get("user_login")||d.get("user_email")||""),E(i)}l&&l.addEventListener("click",o=>{o.preventDefault(),E(i)});function E(o){o.classList.add("show"),document.body.style.overflow="hidden"}function f(o){o.classList.remove("show"),document.body.style.overflow="auto"}e==null||e.addEventListener("click",()=>f(i)),n==null||n.addEventListener("click",()=>f(r)),i==null||i.addEventListener("click",o=>o.target===i&&f(i)),r==null||r.addEventListener("click",o=>o.target===r&&f(r)),t==null||t.addEventListener("click",o=>{o.preventDefault(),f(i),E(r)}),s==null||s.addEventListener("click",o=>{o.preventDefault(),f(r),E(i)});function I(o,c=null){const m=document.getElementById("usernameDisplay");o&&c?m.textContent=c.login:m.textContent=""}function L(){const o=localStorage.getItem("isLoggedIn")==="true",c=JSON.parse(localStorage.getItem("userData")||"null");I(o,c)}a==null||a.addEventListener("submit",async o=>{o.preventDefault();const c=new FormData(a),m={login:c.get("login"),email:c.get("email"),password:c.get("password")};try{const y=await fetch("/api/users/register",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(m)}),g=await y.json(),w=document.getElementById("registerStatusMessage");w.textContent=g.message,w.className=`status-message ${y.ok?"success":"error"}`,y.ok&&(a.reset(),w.textContent="Please check your email and follow the activation link")}catch{const g=document.getElementById("registerStatusMessage");g.textContent="Ошибка сети. Пожалуйста, попробуйте позже.",g.className="status-message error"}}),u==null||u.addEventListener("submit",async o=>{o.preventDefault();const c=new FormData(u),m={loginOrEmail:c.get("loginOrEmail"),password:c.get("password")};try{const y=await fetch("/api/users/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)}),g=await y.json(),w=document.getElementById("loginStatusMessage");w.textContent=g.message,w.className=`status-message ${y.ok?"success":"error"}`,y.ok&&(localStorage.setItem("isLoggedIn","true"),localStorage.setItem("userData",JSON.stringify(g.user)),f(i),I(!0,g.user),window.location.reload())}catch{const g=document.getElementById("loginStatusMessage");g.textContent="Ошибка сети. Пожалуйста, попробуйте позже.",g.className="status-message error"}});const b=window.fetch;window.fetch=(o,c={})=>{const m=localStorage.getItem("token");return c.headers={...c.headers||{},...m?{"X-Session-Id":m}:{}},b(o,c)},p==null||p.addEventListener("click",async o=>{o.preventDefault();try{await fetch("/api/users/logout"),localStorage.clear(),I(!1),window.location.reload()}catch(c){console.error("Logout error:",c)}}),document.addEventListener("click",o=>{var m;const c=o.target.closest("a[href^='#']");c&&(o.preventDefault(),(m=document.getElementById(c.getAttribute("href").slice(1)))==null||m.scrollIntoView({behavior:"smooth",block:"start"}))}),document.querySelectorAll(".password-toggle").forEach(o=>{o.addEventListener("click",function(){const c=this.previousElementSibling,m=c.type==="password"?"text":"password";c.type=m,this.classList.toggle("show")})})});document.addEventListener("DOMContentLoaded",()=>{document.body.addEventListener("click",async d=>{const l=d.target.closest(".product-card__wishlist"),i=d.target.closest(".product-card__btn-remove");if(!l&&!i)return;d.preventDefault();const r=d.target.closest(".product-card, .product-detail__container");if(!r){console.error("Product container not found.");return}const e=r.dataset.productId;if(!e){console.error("Product ID not found.");return}if(i){try{const s=await(await fetch("/api/likes/toggle",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({productId:e})})).json();s.success&&!s.liked&&(r.style.transition="opacity 0.5s ease",r.style.opacity="0",setTimeout(()=>r.remove(),500))}catch(t){console.error("Error removing favorite:",t)}return}if(!document.getElementById("profileDropdown")){const t=document.getElementById("loginModal");t&&(t.classList.add("show"),document.body.style.overflow="hidden");return}try{const t=await fetch("/api/likes/toggle",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({productId:e})});if(t.status===401){alert("Please log in to like products."),window.location.href="/?login=true";return}if(!t.ok)throw new Error("Failed to toggle like status.");const s=await t.json();s.success&&l.classList.toggle("liked",s.liked)}catch(t){console.error("Error:",t)}})});document.addEventListener("DOMContentLoaded",()=>{document.body.addEventListener("click",async e=>{var u;const n=e.target.closest(".product-card__btn, .product-info__btn-cart");if(!n)return;e.preventDefault();const t=e.target.closest(".product-card, .product-detail__container");if(!t)return;const s=t.dataset.productId;if(s)try{const a=await fetch("/api/cart/add",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({productId:s,quantity:1})});if(a.status===401){(u=document.getElementById("loginModal"))==null||u.classList.add("show");return}if(!a.ok)throw new Error("Failed to add to cart");n.textContent="Added!",setTimeout(()=>{n.textContent="Add to Cart"},2e3),r()}catch(a){console.error(a)}});const d=document.querySelector(".cart-page");if(d){const e=d.querySelector(".cart-items");e.addEventListener("click",async n=>{const t=n.target,s=t.closest(".cart-item");if(!s)return;const u=s.dataset.productId,a=s.querySelector(".quantity__input");let p=parseInt(a.value,10);t.matches(".quantity__btn--plus")?(p++,l(u,p,a)):t.matches(".quantity__btn--minus")?(p--,l(u,p,a)):t.matches(".cart-item__remove")&&l(u,0,a)}),e.addEventListener("change",n=>{const t=n.target;if(t.matches(".quantity__input")){const u=t.closest(".cart-item").dataset.productId,a=parseInt(t.value,10);l(u,a,t)}})}async function l(e,n,t){try{if(!(await fetch("/api/cart/update",{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({productId:e,quantity:n})})).ok)throw new Error("Failed to update cart");n<=0?t.closest(".cart-item").remove():t.value=n,i()}catch(s){console.error(s)}}function i(){const e=document.querySelectorAll(".cart-item");if(e.length===0){document.querySelector(".cart-content").innerHTML='<p class="cart-empty-message">Your cart is empty. <a href="/catalog">Continue shopping</a>.</p>';return}let n=0;e.forEach(t=>{const s=parseFloat(t.querySelector(".cart-item__price").textContent),u=parseInt(t.querySelector(".quantity__input").value,10),a=s*u;t.querySelector(".cart-item__total-price").textContent=`${a.toFixed(2)} ₽`,n+=a}),document.querySelector(".summary-subtotal").textContent=`${n.toFixed(2)} ₽`,document.querySelector(".summary-grand-total").textContent=`${n.toFixed(2)} ₽`}async function r(){try{const e=await fetch("/api/cart");if(!e.ok)return;const t=(await e.json()).cart.reduce((u,a)=>u+a.quantity,0),s=document.querySelector(".header__cart-count");s&&(s.textContent=t,s.style.display=t>0?"flex":"none")}catch(e){console.error("Failed to fetch cart count",e)}}r()});document.addEventListener("DOMContentLoaded",()=>{const d=document.querySelector(".admin-dashboard");if(!d)return;const l=d.querySelectorAll(".admin-nav-btn"),i=d.querySelectorAll(".admin-section");l.forEach(r=>{r.addEventListener("click",()=>{l.forEach(t=>t.classList.remove("active")),i.forEach(t=>{t.style.display="none"}),r.classList.add("active");const e=r.dataset.target,n=d.querySelector(`#${e}`);n&&(n.style.display="block")})})});document.addEventListener("DOMContentLoaded",()=>{if(!document.querySelector(".admin-edit-controls"))return;const l=document.getElementById("edit-about-btn"),i=document.getElementById("save-about-btn"),r=document.getElementById("cancel-about-btn"),e=document.getElementById("about-content-display"),n=document.getElementById("about-content-editor"),t=document.getElementById("about-content-textarea"),s=()=>{tinymce.init({selector:"#about-content-textarea",plugins:"autolink lists link image charmap preview anchor searchreplace visualblocks code fullscreen insertdatetime media table powerpaste wordcount",toolbar:"undo redo | styles | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image",height:500})},u=()=>{const a=tinymce.get("about-content-textarea");a&&a.remove()};l.addEventListener("click",()=>{e.style.display="none",n.style.display="block",t.value=e.innerHTML.trim(),s(),l.style.display="none",i.style.display="inline-block",r.style.display="inline-block"}),r.addEventListener("click",()=>{u(),e.style.display="block",n.style.display="none",l.style.display="inline-block",i.style.display="none",r.style.display="none"}),i.addEventListener("click",async()=>{const a=tinymce.get("about-content-textarea").getContent();try{const p=await fetch("/about/update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:a})});if(!p.ok)throw new Error("Failed to save content");const h=await p.json();h.success?(e.innerHTML=a,r.click()):alert("Error saving: "+(h.error||"Unknown error"))}catch(p){console.error("Save error:",p),alert("An error occurred while saving.")}})});
