document.addEventListener("DOMContentLoaded",()=>{const g=new URLSearchParams(window.location.search),v=document.getElementById("profileBtn"),n=document.getElementById("loginModal"),c=document.getElementById("registerModal");document.getElementById("userMenu");const p=document.getElementById("closeLoginModal"),w=document.getElementById("closeRegisterModal"),f=document.getElementById("showRegisterModal"),y=document.getElementById("showLoginModal"),u=document.getElementById("loginForm"),i=document.getElementById("registerForm"),E=document.getElementById("logoutBtn");L();const h=document.getElementById("profileDropdownBtn"),m=document.getElementById("profileDropdown");if(h&&h.addEventListener("click",e=>{e.stopPropagation(),m.classList.toggle("show")}),window.addEventListener("click",e=>{m&&!m.contains(e.target)&&!h.contains(e.target)&&m.classList.remove("show")}),g.has("activated")){const e=document.getElementById("loginStatusMessage");e&&(e.textContent="Account successfully activated. Please sign in.",e.className="status-message success"),d(n);const t=window.location.protocol+"//"+window.location.host+window.location.pathname;window.history.pushState({path:t},"",t)}if(g.has("login")){const e=document.querySelector('#loginForm input[name="loginOrEmail"]');e&&(e.value=g.get("user_login")||g.get("user_email")||""),d(n)}v&&v.addEventListener("click",e=>{e.preventDefault(),d(n)});function d(e){e.classList.add("show"),document.body.style.overflow="hidden"}function r(e){e.classList.remove("show"),document.body.style.overflow="auto"}p==null||p.addEventListener("click",()=>r(n)),w==null||w.addEventListener("click",()=>r(c)),n==null||n.addEventListener("click",e=>e.target===n&&r(n)),c==null||c.addEventListener("click",e=>e.target===c&&r(c)),f==null||f.addEventListener("click",e=>{e.preventDefault(),r(n),d(c)}),y==null||y.addEventListener("click",e=>{e.preventDefault(),r(c),d(n)});function I(e,t=null){const o=document.getElementById("usernameDisplay");e&&t?o.textContent=t.login:o.textContent=""}function L(){const e=localStorage.getItem("isLoggedIn")==="true",t=JSON.parse(localStorage.getItem("userData")||"null");I(e,t)}i==null||i.addEventListener("submit",async e=>{e.preventDefault();const t=new FormData(i),o={login:t.get("login"),email:t.get("email"),password:t.get("password")};try{const s=await fetch("/api/users/register",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(o)}),a=await s.json(),l=document.getElementById("registerStatusMessage");l.textContent=a.message,l.className=`status-message ${s.ok?"success":"error"}`,s.ok&&(i.reset(),l.textContent="Please check your email and follow the activation link")}catch{const a=document.getElementById("registerStatusMessage");a.textContent="Network error. Please try again later.",a.className="status-message error"}}),u==null||u.addEventListener("submit",async e=>{e.preventDefault();const t=new FormData(u),o={loginOrEmail:t.get("loginOrEmail"),password:t.get("password")};try{const s=await fetch("/api/users/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),a=await s.json(),l=document.getElementById("loginStatusMessage");l.textContent=a.message,l.className=`status-message ${s.ok?"success":"error"}`,s.ok&&(localStorage.setItem("isLoggedIn","true"),localStorage.setItem("userData",JSON.stringify(a.user)),r(n),I(!0,a.user),window.location.reload())}catch{const a=document.getElementById("loginStatusMessage");a.textContent="Network error. Please try again later.",a.className="status-message error"}});const k=window.fetch;window.fetch=(e,t={})=>{const o=localStorage.getItem("token");return t.headers={...t.headers||{},...o?{"X-Session-Id":o}:{}},k(e,t)},E==null||E.addEventListener("click",async e=>{e.preventDefault();try{await fetch("/api/users/logout"),localStorage.clear(),I(!1),window.location.reload()}catch(t){console.error("Logout error:",t)}}),document.addEventListener("click",e=>{var o;const t=e.target.closest("a[href^='#']");if(t){e.preventDefault();const s=t.getAttribute("href").slice(1);s&&((o=document.getElementById(s))==null||o.scrollIntoView({behavior:"smooth",block:"start"}))}}),document.querySelectorAll(".password-toggle").forEach(e=>{e.addEventListener("click",function(){const t=this.previousElementSibling,o=t.type==="password"?"text":"password";t.type=o,this.classList.toggle("show")})})});
