document.addEventListener("DOMContentLoaded",()=>{const t=document.querySelector(".admin-dashboard");if(!t)return;const r=t.querySelectorAll(".admin-nav-btn"),e=t.querySelectorAll(".admin-section");if(new URLSearchParams(window.location.search).get("tab")==="products"){r.forEach(o=>{o.classList.remove("active")}),e.forEach(o=>{o.style.display="none"});const a=Array.from(r).find(o=>o.dataset.target==="products-section"),n=t.querySelector("#products-section");a&&n&&(a.classList.add("active"),n.style.display="block")}r.forEach(a=>{a.addEventListener("click",()=>{r.forEach(d=>d.classList.remove("active")),e.forEach(d=>{d.style.display="none"}),a.classList.add("active");const n=a.dataset.target,o=t.querySelector(`#${n}`);o&&(o.style.display="block")})});const c=document.getElementById("addProductForm");c&&c.addEventListener("submit",async function(a){a.preventDefault();const n=new FormData(c);if(Array.from(n.getAll("images")).some(d=>d&&d.size>0))try{(await fetch("/admin/products/new",{method:"POST",body:n})).ok?(closeAddProductModal(),window.location.href=window.location.pathname+"?tab=products"):alert("Failed to add product")}catch(d){alert("Error: "+d.message)}else{const d={name:n.get("name"),price:n.get("price"),old_price:n.get("old_price"),brand:n.get("brand"),article:n.get("article"),category:n.get("category"),description:n.get("description")},i={};n.get("spec_material")&&(i.material=n.get("spec_material")),n.get("spec_stone_type")&&(i.stone_type=n.get("spec_stone_type")),n.get("spec_weight")&&(i.weight=n.get("spec_weight")),n.get("spec_length")&&(i.length=n.get("spec_length")),d.spec_json=JSON.stringify(i);try{(await fetch("/admin/products/new",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)})).ok?(closeAddProductModal(),window.location.href=window.location.pathname+"?tab=products"):alert("Failed to add product")}catch(l){alert("Error: "+l.message)}}}),document.querySelectorAll(".btn-filter").forEach(a=>{a.addEventListener("click",function(){document.querySelectorAll(".btn-filter").forEach(o=>o.classList.remove("active")),a.classList.add("active");const n=a.dataset.category;document.querySelectorAll(".admin-table tbody tr").forEach(o=>{n==="all"||o.dataset.category===n?o.style.display="":o.style.display="none"})})}),_("addProductForm","add-dropzone","add-image-preview"),_("editProductForm","edit-dropzone","edit-image-preview")});window.showAddProductModal=function(){const t=document.getElementById("addProductModal");t&&(t.style.display="block",document.body.style.overflow="hidden")};window.closeAddProductModal=function(){const t=document.getElementById("addProductModal");t&&(t.style.display="none",document.body.style.overflow="")};window.deleteProduct=async function(t){if(confirm("Are you sure you want to delete this product?"))try{const r=await fetch(`/admin/products/${t}/delete`,{method:"POST",headers:{"Content-Type":"application/json"}});if(r.ok)window.location.href=window.location.pathname+"?tab=products";else{const e=await r.json();alert(e.error||"Failed to delete product")}}catch(r){alert("Error: "+r.message)}};window.showEditProductModal=function(t){const r=document.getElementById("editProductModal"),e=document.getElementById("editProductForm");if(r&&e){let n=function(){c.innerHTML="";for(let o=0;o<4;o++){const d=window._editImages[o];console.log("rendering image",d);const i=document.createElement("div");if(i.className="image-preview__item",i.draggable=!0,i.ondragstart=function(l){l.dataTransfer.setData("text/plain",o),i.classList.add("dragging")},i.ondragend=function(){i.classList.remove("dragging")},i.ondragover=function(l){l.preventDefault(),i.classList.add("dragover")},i.ondragleave=function(){i.classList.remove("dragover")},i.ondrop=function(l){l.preventDefault(),i.classList.remove("dragover");const s=+l.dataTransfer.getData("text/plain");if(s!==o){const f=window._editImages,g=f[s];f[s]=f[o],f[o]=g,n()}},d){const l=document.createElement("img");l.src=d,i.appendChild(l),console.log("appended image",l.src);const s=document.createElement("button");s.type="button",s.className="image-preview__remove",s.innerHTML="&times;",s.title="Удалить изображение",s.onclick=function(){window._editImages[o]=null,n(),e.existing_images&&(e.existing_images.value=JSON.stringify(window._editImages))},i.appendChild(s)}c.appendChild(i)}e.existing_images&&(e.existing_images.value=JSON.stringify(window._editImages))};var p=n;e.id.value=t.id,e.name.value=t.name,e.price.value=t.price,e.old_price.value=t.old_price||"",e.brand.value=t.brand||"",e.article.value=t.article||"",e.category.value=t.category||"",e.description.value=t.description||"";let m={};try{t.spec_json&&(m=typeof t.spec_json=="string"?JSON.parse(t.spec_json):t.spec_json)}catch{m={}}e.spec_material.value=m.material||"",e.spec_stone_type.value=m.stone_type||"",e.spec_weight.value=m.weight||"",e.spec_length.value=m.length||"";const c=document.getElementById("edit-image-preview");c.innerHTML="";let a=[];try{t.images&&(a=typeof t.images=="string"?JSON.parse(t.images||"[]"):t.images)}catch{a=[]}for(Array.isArray(a)||(a=[]),window._editImages=a.slice(0,4);window._editImages.length<4;)window._editImages.push(null);console.log("editImages",window._editImages),e.existing_images&&(e.existing_images.value=JSON.stringify(window._editImages)),n(),r.style.display="block",document.body.style.overflow="hidden"}};window.closeEditProductModal=function(){const t=document.getElementById("editProductModal");t&&(t.style.display="none",document.body.style.overflow="")};document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("editProductForm");t&&t.addEventListener("submit",async function(r){r.preventDefault();const e=new FormData(t),p=e.get("id");if(Array.from(e.getAll("images")).some(c=>c&&c.size>0))try{(await fetch(`/admin/products/${p}/edit`,{method:"POST",body:e})).ok?(closeEditProductModal(),window.location.href=window.location.pathname+"?tab=products"):alert("Failed to update product")}catch(c){alert("Error: "+c.message)}else{const c={name:e.get("name"),price:e.get("price"),old_price:e.get("old_price"),brand:e.get("brand"),article:e.get("article"),category:e.get("category"),description:e.get("description")},a={};e.get("spec_material")&&(a.material=e.get("spec_material")),e.get("spec_stone_type")&&(a.stone_type=e.get("spec_stone_type")),e.get("spec_weight")&&(a.weight=e.get("spec_weight")),e.get("spec_length")&&(a.length=e.get("spec_length")),c.spec_json=JSON.stringify(a);try{(await fetch(`/admin/products/${p}/edit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)})).ok?(closeEditProductModal(),window.location.href=window.location.pathname+"?tab=products"):alert("Failed to update product")}catch(n){alert("Error: "+n.message)}}})});window.editProduct=function(t){const r=document.querySelector(`button[onclick='editProduct(${t})']`).closest("tr"),e={id:t,name:r.children[1].textContent,price:r.children[2].textContent,brand:r.children[3].textContent,description:r.dataset.description||"",old_price:r.dataset.oldPrice||"",article:r.dataset.article||"",category:r.dataset.category||"",spec_json:r.dataset.specJson||"",images:r.dataset.images||""};showEditProductModal(e)};function _(t,r,e){const p=document.getElementById(t);if(!p)return;const m=document.getElementById(r),c=document.getElementById(e),a=p.querySelectorAll('input[type="file"][name="images"]');function n(){c.innerHTML="",a.forEach((o,d)=>{if(o.files&&o.files[0]){const i=new FileReader;i.onload=function(l){const s=document.createElement("div");s.className="image-preview__item",s.draggable=!0,s.ondragstart=function(u){u.dataTransfer.setData("text/plain",d),s.classList.add("dragging")},s.ondragend=function(){s.classList.remove("dragging")},s.ondragover=function(u){u.preventDefault(),s.classList.add("dragover")},s.ondragleave=function(){s.classList.remove("dragover")},s.ondrop=function(u){u.preventDefault(),s.classList.remove("dragover");const y=+u.dataTransfer.getData("text/plain"),w=d;if(y!==w){const h=new DataTransfer;a[y].files[0]&&h.items.add(a[y].files[0]);const v=new DataTransfer;a[w].files[0]&&v.items.add(a[w].files[0]),a[y].files=v.files,a[w].files=h.files,n()}};const f=document.createElement("img");f.src=l.target.result,s.appendChild(f);const g=document.createElement("button");g.type="button",g.className="image-preview__remove",g.innerHTML="&times;",g.title="Удалить изображение",g.onclick=function(){o.value="",n()},s.appendChild(g),c.appendChild(s)},i.readAsDataURL(o.files[0])}})}a.forEach(o=>{o.addEventListener("change",n)}),m&&(m.addEventListener("dragover",o=>{o.preventDefault(),m.classList.add("dragover")}),m.addEventListener("dragleave",o=>{o.preventDefault(),m.classList.remove("dragover")}),m.addEventListener("drop",o=>{o.preventDefault(),m.classList.remove("dragover");const d=Array.from(o.dataTransfer.files).filter(l=>l.type.startsWith("image/")).slice(0,a.length);let i=0;d.forEach(l=>{for(;i<a.length&&a[i].files.length>0;)i++;if(i<a.length){const s=new DataTransfer;s.items.add(l),a[i].files=s.files,i++}}),n()}),m.addEventListener("click",()=>{a[0]&&a[0].click()}))}
